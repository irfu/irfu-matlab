%
% matlab.unittest automatic test code for bicas.utils.cli.parse_CLI_options().
%
%
% Author: Erik P G Johansson, IRF, Uppsala, Sweden
% First created 2021-09-10
%
classdef parse_CLI_options___UTEST < matlab.unittest.TestCase



  %##############
  %##############
  % TEST METHODS
  %##############
  %##############
  methods(Test)



    function test0(testCase)

      % NOTE: Arguments OptionsConfigMap, inputStr switch places to make
      %       test code look better.
      function test(CliOptionConfigArray, inputStr, outputMapKeys, outputMapValues)
        cliArgumentsCa = strsplit(inputStr)';

        ExpOptionValuesMap = containers.Map(outputMapKeys, outputMapValues);

        ActOptionValuesMap = bicas.utils.cli.parse_CLI_options(...
          cliArgumentsCa, CliOptionConfigArray);

        testCase.assertEqual(ActOptionValuesMap, ExpOptionValuesMap)
      end



      % NOTE: Arguments OptionsConfigMap, inputStr switch places to make
      %       test code look better.
      function test_exc(CliOptionConfigArray, inputStr)
        cliArgumentsCa = strsplit(inputStr)';

        assert(isa(CliOptionConfigArray, 'bicas.utils.cli.CliOptionConfig'))
        assert(iscolumn(CliOptionConfigArray))

        testCase.assertError(...
          @() bicas.utils.cli.parse_CLI_options(...
          cliArgumentsCa, CliOptionConfigArray), ...
          ?MException)
      end

      %===================================================================
      import bicas.utils.cli.CliOptionConfig
      import bicas.utils.cli.CliOptionValue



      % OCM = Options Config Map
      OCM1 = [...
        CliOptionConfig('a', '-a', '0-1',   0, 0); ...
        CliOptionConfig('b', '-b', '1',     1, 0); ...
        CliOptionConfig('c', '-c', '0-inf', 2, 0)...
        ];
      OCM2 = [...
        CliOptionConfig('--', '--.*', '0-1',   0, 0); ...
        CliOptionConfig('==', '==.*', '0-inf', 0, 0) ...
        ];
      OCM3 = [...
        CliOptionConfig('all', '--.*',    '0-inf', 1, -1); ...
        CliOptionConfig('log', '--log',   '1',     1, 0); ...
        CliOptionConfig('set', '--set.*', '0-inf', 1, 0) ...
        ];

      COPV_0x1 = bicas.utils.cli.CliOptionValue.empty(0, 1);



      % Missing option -b.
      test_exc(OCM1, '-a')



      test(OCM1, '-b 123',           {'a', 'b', 'c'}, {COPV_0x1,                           CliOptionValue(1, '-b', {'123'}), COPV_0x1});
      test(OCM1, '-a -b 123',        {'a', 'b', 'c'}, {CliOptionValue(1, '-a', cell(0,1)), CliOptionValue(2, '-b', {'123'}), COPV_0x1});
      test(OCM1, '-a -b 123 -c 8 9', {'a', 'b', 'c'}, {CliOptionValue(1, '-a', cell(0,1)), CliOptionValue(2, '-b', {'123'}), CliOptionValue(4, '-c', {'8'; '9'})});



      % Test multiple occurrences of the same option.
      test(OCM1, '-c 6 7 -a -b 123 -c 8 9', ...
        {'a', 'b', 'c'}, ...
        { ...
        CliOptionValue(4, '-a', cell(0,1)), ...
        CliOptionValue(5, '-b', {'123'}), ...
        [ ...
        CliOptionValue(1, '-c', {'6'; '7'}), ...
        CliOptionValue(7, '-c', {'8'; '9'}) ...
        ] ...
        } ...
        );
      % Test multiple occurrences of the same option.
      test(OCM1, '-c 6 7 -b 123 -c 8 9', ...
        {'a', 'b', 'c'}, ...
        { ...
        COPV_0x1, ...
        CliOptionValue(4, '-b', {'123'}), ...
        [ ...
        CliOptionValue(1, '-c', {'6'; '7'}), ...
        CliOptionValue(6, '-c', {'8'; '9'})...
        ] ...
        } ...
        );

      test(OCM2, '--ASD',           {'--', '=='}, ...
        { ...
        CliOptionValue(1, '--ASD', cell(0,1)), ...
        COPV_0x1 ...
        });
      test(OCM2, '==ASD ==a --abc', {'--', '=='}, ...
        { ...
        CliOptionValue(3, '--abc', cell(0,1)), ...
        [ ...
        CliOptionValue(1, '==ASD', cell(0,1)), ...
        CliOptionValue(2, '==a',   cell(0,1))...
        ] ...
        } ...
        );



      test(OCM3, '--input1 i1 --output1 o1 --log logfile', ...
        {'all', 'log', 'set'}, ...
        { ...
        [ ...
        CliOptionValue(1, '--input1',  {'i1'}), ...
        CliOptionValue(3, '--output1', {'o1'})...
        ], ...
        CliOptionValue(5, '--log',     {'logfile'}), ...
        COPV_0x1 ...
        } ...
        );

      test(OCM3, '--input1 i1 --output1 o1 --log logfile --setDEBUG ON', ...
        {'all', 'log', 'set'}, ...
        { ...
        [ ...
        CliOptionValue(1, '--input1',  {'i1'}), ...
        CliOptionValue(3, '--output1', {'o1'})...
        ], ...
        CliOptionValue(5, '--log',      {'logfile'}), ...
        CliOptionValue(7, '--setDEBUG', {'ON'}) ...
        } ...
        );

    end



  end    % methods(Test)



end
